(function(j){Array.prototype.shuffle=function(){for(var g,a,n=this.length;n;g=parseInt(Math.random()*n),a=this[--n],this[n]=this[g],this[g]=a);return this};j.wordCloudSupported=function(){var g=j("<canvas />");if(!g[0]||!g[0].getContext)return false;g=g[0].getContext("2d");if(!g.getImageData)return false;if(!g.fillText)return false;if(!Array.prototype.some)return false;if(!Array.prototype.push)return false;return true}();j.fn.wordCloud=function(g){if(!j.wordCloudSupported)return this;var a={fontFamily:'"Trebuchet MS", "Heiti TC", "\u5fae\u8edf\u6b63\u9ed1\u9ad4", "Arial Unicode MS", "Droid Fallback Sans", sans-serif',
gridSize:8,ellipticity:0.65,drawMask:false,maskColor:"rgba(255,0,0,0.3)",maskGridWidth:0.3,wordColor:"rgba(0,0,0,0.7)",backgroundColor:"rgba(255, 255, 255, 1)",wait:0,abortThreshold:0,abort:j.noop,weightFactor:1,wordList:[],clearCanvas:true};g&&j.extend(a,g);if(typeof a.weightFactor!=="function"){var n=a.weightFactor;a.weightFactor=function(b){return b*n}}a.gridSize=Math.max(a.gridSize,4);var c=a.gridSize,e,p,k,l,z,A,B,s,C=function(){return a.abortThreshold>0&&(new Date).getTime()-B>a.abortThreshold},
D=function(b,f,d,q){d=d;var i;if(a.drawMask)e.fillStyle=a.maskColor;a:for(;d--;)for(i=q;i--;){var h;b:{h=c*c*4;for(var r=e.getImageData((b+d)*c,(f+i)*c,c,c);h-=4;)if(r.data[h+z]!==A){h=false;break b}h=true}if(!h){p[b+d][f+i]=false;a.drawMask&&e.fillRect((b+d)*c,(f+i)*c,c-a.maskGridWidth,c-a.maskGridWidth)}if(C())break a}},F=function(b,f){e.font=a.weightFactor(f).toString(10)+"px "+a.fontFamily;var d=e.measureText(b).width,q=Math.max(a.weightFactor(f),e.measureText("m").width,e.measureText("\uff37").width),
i,h;if(a.weightFactor(f)===0)return false;if(/[gpqy]/.test(b))q*=1.5;i=Math.ceil(d/c);h=Math.ceil(q/c);var r=Math.floor(Math.sqrt(k*k+l*l)),v=k+l,t,u,w;for(t=r;t--;){u=v;for(w=[];u--;)w.push([Math.floor(k/2+(r-t)*Math.cos(u/v*2*Math.PI)-i/2),Math.floor(l/2+(r-t)*a.ellipticity*Math.sin(u/v*2*Math.PI)-h/2)]);if(w.shuffle().some(function(o){var m;a:{m=o[0];var x=o[1];if(m<0||x<0||m+i>k||x+h>l)m=false;else{for(var E=i,y;E--;)for(y=h;y--;)if(!p[m+E][x+y]){m=false;break a}m=true}}if(m){e.fillStyle=a.wordColor;
e.fillText(b,o[0]*c+(i*c-d)/2,o[1]*c+(h*c-q)/2);D(o[0],o[1],i,h);return true}return false}))return true}return false};return this.each(function(){if(this.nodeName.toLowerCase()==="canvas"){k=Math.floor(j(this).attr("width")/c);l=Math.floor(j(this).attr("height")/c);e=this.getContext("2d");p=[];var b=document.createElement("canvas").getContext("2d");b.fillStyle=a.backgroundColor;b.clearRect(0,0,1,1);b.fillStyle=a.backgroundColor;b.fillRect(0,0,1,1);var f=b.getImageData(0,0,1,1).data;b.fillStyle=a.wordColor;
b.fillRect(0,0,1,1);b=b.getImageData(0,0,1,1).data;for(var d=4;d--;)if(Math.abs(b[d]-f[d])>10){z=d;A=f[d];break}for(f=k;f--;){p[f]=[];for(b=l;b--;)p[f][b]=true}if(a.clearCanvas){e.fillStyle=a.backgroundColor;e.clearRect(0,0,k*(c+1),l*(c+1));e.fillRect(0,0,k*(c+1),l*(c+1))}else D(0,0,k,l);e.textBaseline="top";clearTimeout(j(this).data("wordCloud-timer"));d=0;s=setInterval(function(){if(d>=a.wordList.length)clearTimeout(s);else{B=(new Date).getTime();F(a.wordList[d][0],a.wordList[d][1]);if(C()){clearTimeout(s);
a.abort()}d++}},a.wait);j(this).data("wordCloud-timer",s)}})}})(jQuery);